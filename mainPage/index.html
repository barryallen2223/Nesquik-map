<!DOCTYPE html>
<html>

<head>
    <title>NesquikApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/x-icon" href="./assets/icon.ico">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <script>
        function initMap() {

            const options = {
                zoom: 12,
                center: { lat: 6.2476, lng: -75.5658 },
                mapId: '122c8cd93cebd911',
                disableDefaultUI: true, // a way to quickly hide all controls
                streetViewControl: false,
                mapTypeControl: false
            }

            const searchable = JSON.parse(localStorage.getItem('searchable'));
            const positions = JSON.parse(localStorage.getItem('positions'));
            const locations = JSON.parse(localStorage.getItem('locations'));
            console.log(locations);
            const map = new google.maps.Map(document.getElementById("map"), options);
            const icon = document.createElement("div");

            const infoWindow = new google.maps.InfoWindow();
            locations.forEach(({ position, title, type, address, comments, rating, bathroom, chargePoint, accessibleEntrance }, i) => {
                const icon = document.createElement("div");
                icon.innerHTML = `<i aria-hidden="true" style="font-size: 18px; justify-content: center;" class="fa-solid fa-${type}" title="${type}"></i>`;

                const pinView = new google.maps.marker.PinView({
                    glyph: icon,
                    glyphColor: "#FFF",
                    background: "#7F00A2",
                    borderColor: "#672979",
                    scale: 1.2,
                });

                const marker = new google.maps.marker.AdvancedMarkerView({
                    position,
                    map,
                    title: `${title}`,
                    content: pinView.element,
                });

                // Add a click listener for each marker, and set up the info window.
                marker.addListener("click", ({ domEvent, latLng }) => {
                    const { target } = domEvent;
                    const cont = document.querySelector('.container');
                    const modalClose = document.querySelector('.btnHide');
                    const commentOwner = document.querySelectorAll('.commentOwner');
                    const commentContent = document.querySelectorAll('.commentContent');

                    const sum = rating.reduce((accumulator, currentValue) => accumulator + currentValue, 0);
                    const average = sum / rating.length;
                    var avgRounded = 0.0;
                    if (average >= 0 && average < 3.25) {
                        avgRounded = Math.floor(average);
                    } else if (average >= 3.25 && average < 3.75) {
                        avgRounded = 3.5;
                    } else {
                        avgRounded = Math.ceil(average);
                    }
                    const fullStars = Math.floor(avgRounded);
                    const halfStars = avgRounded - fullStars;
                    // Show the modal when a button is clicked
                    cont.style.display = 'block';
                    document.getElementById('ratingStars').innerHTML = `
                    <div>
                        <span id="rating">Puntuaci칩n</span>
                        <br>
                        ${fullStars > 0 ? `<i aria-hidden="true" class="fa fa-star fa-lg star" title="rating"></i>` : ''}
                        ${Array(fullStars - 1).fill().map(() => `<i aria-hidden="true" class="fa fa-star fa-lg star" title="rating"></i>`).join('')}
                        ${halfStars > 0 ? `<i aria-hidden="true" class="fa-solid fa-star-half-stroke fa-lg star" title="rating"></i>` : ''}
                        <span class="fa-sr-only">rating</span>
                        ${fullStars == 0 && halfStars == 0 ? `<i aria-hidden="true" class="fa-regular fa-star fa-lg star" title="rating"></i>` : ''}
                    </div>`;
                    document.getElementById('bathroom').innerHTML = `
                        <span>Ba침o accesible</span>
                        <i aria-hidden="true" class="fa-solid fa-toilet fa-lg bathroom" title="bathroom"></i>
                        ${bathroom ? `<i aria-hidden="true" class="fa fa-check-circle fa-lg check-circle" title="bath"></i>` : `<i aria-hidden="true" class="fa fa-times-circle fa-lg times-circle" title="bath"></i>`}
                        <span class="fa-sr-only">bathroom</span>`;
                    document.getElementById('chargePoint').innerHTML = `
                        <span>Puntos de carga</span>
                        <i aria-hidden="true" class="fa-solid fa-bolt-lightning fa-lg chargePoint" title="chargePoint"></i>
                        ${chargePoint ? `<i aria-hidden="true" class="fa fa-check-circle fa-lg check-circle" title="charge"></i>` : `<i aria-hidden="true" class="fa fa-times-circle fa-lg times-circle" title="charge"></i>`}
                        <span class="fa-sr-only">chargePoint</span>`;
                    document.getElementById('accessibleEntrance').innerHTML = `
                        <span>Entrada accesible</span>
                        <i aria-hidden="true" class="fa fa-wheelchair fa-lg wheelchair" title="ramp"></i>
                        ${accessibleEntrance ? `<i aria-hidden="true" class="fa fa-check-circle fa-lg check-circle" title="ramp"></i>` : `<i aria-hidden="true" class="fa fa-times-circle fa-lg times-circle" title="ramp"></i>`}
                        <span class="fa-sr-only">ramp</span>`;
                    document.querySelector('.placeName').textContent = title;
                    document.querySelector('.placeAddress').textContent = address;
                    const commentsContainer = document.querySelector('.commentsContainer');
                    commentsContainer.innerHTML = '';

                    comments.forEach((comment) => {
                        const [owner, content] = comment.split(' | ');

                        const ownerEl = document.createElement('p');
                        ownerEl.classList.add('commentOwner');
                        ownerEl.textContent = owner;

                        const contentEl = document.createElement('p');
                        contentEl.classList.add('commentContent');
                        contentEl.textContent = content;

                        const imgEl = document.createElement('img');
                        const picName = owner.split(' ');
                        var picPath = 'assets/images/users/';
                        imgEl.classList.add('userImage');
                        imgEl.setAttribute('src', picPath.concat(picName[0], '.png'));
                        imgEl.setAttribute('alt', 'User Image');

                        const commentsWrapper = document.createElement('div');
                        commentsWrapper.classList.add('commentInfo');
                        commentsWrapper.appendChild(imgEl);
                        commentsWrapper.appendChild(ownerEl);
                        commentsWrapper.appendChild(contentEl);

                        commentsContainer.appendChild(commentsWrapper);
                    });


                    modalClose.addEventListener('click', () => {
                        cont.style.display = 'none';
                    });

                    infoWindow.close();
                    infoWindow.setContent(marker.title);
                    //infoWindow.open(marker.map, marker);
                });

            });

        }
        window.initMap = initMap;
    </script>
</head>

<body>
    <header>
        <h1>Nesquik</h1>
        <div class="search-container">
            <input type="text" placeholder="Search place...">
            <i class="fa fa-search"></i>
        </div>
        <nav>
            <a href="#">Todos <i class="fa-solid fa-globe"></i></a>
            <a href="#">Ba침os accesibles <i class="fa-solid fa-toilet"></i></a>
            <a href="#">Puntos de carga <i class="fa-solid fa-bolt-lightning"></i></a>
            <a href="#">Entrada accesible <i class="fa-solid fa-wheelchair"></i></a>
        </nav>
    </header>

    <div id="left-panel">
        <div class="section section-user">
            <div class="user-info">
                <img src="assets/images/user.jpg" alt="User Picture">
                <h3></h3>
            </div>
        </div>
        <div class="section section-marker">
            <p>Nuevo marcador <i class="fa-solid fa-location-dot"></i></p>
            <button class="markerBtn" id="markerBtn"><i class="fa-solid fa-arrow-right"></i></button>
        </div>
        <div class="section section-challenges">
            <button class="challengeBtn" id="challengeBtn">Retos <i class="fa-solid fa-flag"></i></button>
        </div>
        <div class="section section-leaderboard">
            <h3>Tabla de clasificaci칩n</h3>
            <hr>
            <div class="leaderboard-users">
                <div class="user">
                    <span class="user-position-1"><i class="fa-solid fa-medal"></i></span>
                    <span class="user-name">John Deez</span>
                    <span class="user-points">1000 points</span>
                </div>
                <div class="user">
                    <span class="user-position-2"><i class="fa-solid fa-medal"></i></span>
                    <span class="user-name">Jane Smith</span>
                    <span class="user-points">750 points</span>
                </div>
                <div class="user">
                    <span class="user-position-3"><i class="fa-solid fa-medal"></i></span>
                    <span class="user-name">Bob Johnson</span>
                    <span class="user-points">500 points</span>
                </div>
            </div>
        </div>

        <div class="section section-logout">
            <button class="logoutBtn" id="logoutBtn">Log Out <i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </div>
    <div class="container">
        <div class="tab_box">
            <button class="tab_btn active">General</button>
            <button class="tab_btn">Comentarios</button>
            <button class="btnHide" id="close-modal-button">&times;</button>
            <div class="line"></div>
        </div>
        <div class="content_box">
            <div class="content active">
                <h3 class="placeName"></h3>
                <p class="placeAddress"></p>
                <div class="features">
                    <div id="ratingStars"></div>
                    <div id="bathroom"></div>
                    <div id="chargePoint"></div>
                    <div id="accessibleEntrance"></div>
                </div>
            </div>
            <div class="content">
                <div class="commentInfo">
                    <div class="commentsContainer">
                        <p class="commentOwner"></p>
                        <p class="commentContent"></p>u
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="right-panel">
        <div id="map"></div>
        <script
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOWx1PkAqJP1slIm13vGaezmS6ERahMYs&callback=initMap&libraries=localContext,marker&v=beta"></script>
    </div>
    <script src="assets/js/script.js"></script>
    <script type="module" src="assets/js/firebaseJs.js"></script>
    <script>
        const tabs = document.querySelectorAll('.tab_btn');
        const all_content = document.querySelectorAll('.content');
        tabs.forEach((tab, index) => {
            tab.addEventListener('click', (e) => {
                tabs.forEach(tab => { tab.classList.remove('active') });
                tab.classList.add('active');
                var line = document.querySelector('.line');
                line.style.width = e.target.offsetWidth + "px";
                line.style.left = e.target.offsetLeft + "px";
                all_content.forEach(content => { content.classList.remove('active') });
                all_content[index].classList.add('active');
            });
        })
    </script>
</body>

</html>